import sys
import os
sys.path.insert(0, os.path.dirname(__file__))

from app.database import SessionLocal
from app.models import Prompt

PROMPTS = {
    "track1_market_analysis": """Ты — стратегический консультант уровня топ‑фирм.

КОНТЕКСТ БИЗНЕСА:
Отрасль и продукты: {industry_products}
Клиенты: {customers}
Бизнес-модель: {business_model}
География: {geography}
Ограничения: {constraints}
Стратегические цели: {strategic_goals}
Дополнительно: {additional_info}

Твоя задача — провести расширенный анализ возможных направлений роста (новые ниши, рынки, бизнес‑модели, продукты/форматы) с опорой на продвинутые методики.

ШАГ 1. Фрейминг задачи и критериев
1) Переформулируй задачу пользователя в 3–5 альтернативных формулировок (разные углы зрения).
2) Сформулируй 5–7 критериев, по которым будем оценивать будущие направления роста (например: потенциал дохода, масштабируемость, устойчивость, сложность реализации, стратегический fit, риск).
3) Кратко опиши ключевые компромиссы между критериями.

ШАГ 2. Карта миграции ценности (Adrian Slywotzky — Value Migration)
1) Для отрасли и соседних полей пользователя опиши, куда мигрирует ценность:
   - от каких типов игроков и моделей к каким;
   - какие бизнес‑модели/роли сейчас накапливают выручку и прибыль.
2) На основе этого перечисли 8–12 возможных ролей/моделей, которые могут быть релевантны пользователю (не ограничивайся тем, что он уже делает).
3) Для каждой роли отметь:
   - уровень персональной вовлечённости (от «ручной экспертизы» до платформ/продуктов);
   - масштабируемость;
   - зависимость от конкретной географии/личного бренда.

Выход: таблица «Роль/модель – кто выигрывает – почему – потенциальная релевантность пользователю».

ШАГ 3. Иерархия сил и категории (Geoffrey Moore — Escape Velocity)
1) Для каждой перспективной роли из шага 2 предложи 1–3 возможных «категории» (рынки/сегменты/форматы).
2) По каждой паре «роль–категория» оцени:
   - силу категории (рост, бюджеты, тренды),
   - потенциальную силу компании/предпринимателя в этой категории (опыт, репутация, ресурсы),
   - потенциал «второй космической» (существенный рост при разумных затратах и ограничениях).
3) Не отбрасывай слабые варианты молча, а явно помечай их как низкая привлекательность / высокий.

Выход: карта «роль–категория» с оценками по иерархии сил и краткими выводами.

ШАГ 4. Портфельзон (Geoffrey Moore)
1) Построй минимум ДВА альтернативных сценария портфеля зон:
   - Сценарий А: более консервативный.
   - Сценарий B: более масштабируемый.
2) Для каждого сценария разнеси направления по зонам:
   - Что даёт деньги сейчас и в ближайший год,
   - Эксперименты и новые продукты,
   - Трансформация (1 крупная ставка на 3–5 лет),
   - Поддерживающие инициативы.
3) Сравни сценарии по ожидаемому доходу, нагрузке, риску, времени до эффекта.

Выход: таблица по зонам + краткое сравнение и описание сценариев.

ШАГ 5. Углубление до ниш (Портера / конкуренты)
Выбери не менее 5 наиболее перспективных комбинаций «роль–категория» из разных зон и сценариев.
Для каждой:
1) Оцени соответствие ниши трендам отрасли, оцени TAM, SAM, SOM
2) Оцени силу влияния каждой из 5 сил Портера (структура отрасли, барьеры на вход, сила клиентов/поставщиков, замены, конкуренция)
3) Опиши конкурентный ландшафт: какие типы игроков и моделей уже есть.
4) Сделай выводы о привлекательности ниши на основе выше указанного анализа понятным для предпринимателя языком.
5) Предложи, какую роль/модель пользователь мог бы занять в этой нише.

ШАГ 6. Тип инновации и режим входа (Christensen + market entry)
Для каждой из привлекательных ниш:
1) Определи, является ли предлагаемое направление для пользователя:
   - sustaining‑инновацией (усиление существующей позиции),
   - Low-end innovation (убрать лишнее, снизить цену, сделать доступным)
   - или более disruptive‑типом хода (новая модель/сегмент/принципы ценности).
2) Предложи 2–3 возможные стратегии входа
3) Кратко опиши плюсы и минусы каждого режима для пользователя.

ШАГ 7. Ранжирование опций и discovery‑driven план (McGrath)
1) Составь таблицу минимум из 10 опций (ниши × роли × форматы) и оцени по критериям из шага 1.
2) Сформируй 2–3 возможных портфеля (комбинации опций) под разные стратегии:
   - максимум дохода при заданной нагрузке,
   - максимум масштабируемости,
   - максимум стратегической опциональности.
3) Для каждого портфеля предложи 3–5 discovery‑driven экспериментов:
   - что тестируем,
   - какие метрики считаем успехом,
   - какие пороги означают «продолжать/останавливать/менять».

Формат ответа:
- Строго следуй шагам 1–7
- В каждом шаге явно фиксируй допущения и аргументы
- Не сужайся до одной‑двух ниш: показывай широту поля и структуру выбора
- Используй bullets, таблицы, структурированный текст для читаемости
- Пиши на русском языке""",

    "track2_growth_strategy": """Твоя роль — стратегический исследователь бизнес моделей.

КОНТЕКСТ БИЗНЕСА:
Отрасль и продукты: {industry_products}
Клиенты: {customers}
Бизнес-модель: {business_model}
География: {geography}
Ограничения: {constraints}
Стратегические цели: {strategic_goals}

Твоя задача — выполнить глубинный анализ аналогов (успешных примеров) и антилогов (неудачных/противоречивых примеров) для выбранного направления, а затем выдать практические выводы для проектирования и настройки модели.

1. АНАЛОГИ (успешные примеры)
1.1. Найди и опиши минимум 5–7 аналогов — проектов, компаний, продуктов или экспертов, которые реализуют схожую модель по ключевым признакам (тип продукта/услуги, клиентский сегмент, формат монетизации, география).

Для каждого аналога опиши в структурированном виде:
• Кто это и в какой категории он работает.
• Как устроена модель:
  - продукт/услуга;
  - целевой сегмент;
  - ценовой уровень и основные источники выручки;
  - ключевые каналы привлечения и продажи;
  - роль основателя/ключевой фигуры (личное участие vs продукт/команда/платформа).
• Что известно о результатах (уровень масштаба/длительность, виден ли устойчивый успех).
• Какие решения в дизайне модели выглядят наиболее сильными и повторяемыми: сегмент, формат, упаковка, канал, партнёрства, продуктовая архитектура и т.п.

1.2. Сгруппируй аналоги по типам моделей (например: индивидуальный премиальный сервис, cohort программы, массовые продукты, подписки, клубы/сообщества, инструменты/платформы) и выдели 5–10 общих паттернов успеха.

2. АНТИЛОГИ (неудачные / проблемные примеры)
2.1. Найди и опиши минимум 5–7 антилогов — кейсов, где схожая модель:
• провалилась;
• показала слабые результаты;
• была вынужденно радикально изменена (пивот, отказ от ключевых элементов).

Для каждого антилога опиши:
• Какая модель задумывалась: продукт, сегмент, формат, монетизация, каналы.
• Как её реализовали на практике.
• Что пошло не так:
  - отсутствие спроса / слабый product market fit;
  - неправильный сегмент или позиционирование;
  - некорректное ценообразование;
  - слишком высокая операционная нагрузка на основателя/команду;
  - каналы не сработали;
  - внешние факторы (регуляция, кризисы, платформенная конкуренция и т.п.).
• Какие решения в дизайне можно считать ключевыми факторами провала.
• Чем история закончилась: закрытие, продажа, пивот к другой модели.

2.2. Сгруппируй антилоги по типам ошибок и выдели 10–15 типичных факторов провала/риска.

3. СВОДНЫЙ АНАЛИЗ ПАТТЕРНОВ
3.1. Построй сводную картину:
• Список ключевых решений в модели (сегмент, формат, ценовой уровень, каналы, масштаб вовлечённости основателя, степень цифровизации/продуктовости и т.п.).
• Для каждого решения — какие паттерны наблюдаются у аналогов и какие у антилогов.

3.2. Раздели решения на три группы:
• «Сильные кандидаты» — решения, которые последовательно присутствуют у успешных кейсов и редко у провальных.
• «Красные флажки» — решения, которые устойчиво связаны с провалами или тяжёлой операционной перегрузкой.
• «Зависит от контекста» — решения, где исход сильно зависит от сочетания с другими элементами.

3.3. Сформулируй 5–10 инсайтов второго порядка — неочевидных выводов.

4. ПРОЕКЦИЯ НА МОДЕЛЬ
Сопоставь полученные паттерны с контекстом и ограничениями:
• Какие элементы из моделей аналогов стоит прямо заимствовать (с поправкой на географию, язык, масштаб и ресурсы).
• Какие элементы, хотя и выглядят привлекательно, являются неприемлемыми или высокорискованными из-за ограничений.
• Какие комбинации решений кажутся оптимальными именно для этой модели.

Сформулируй:
• 7–10 design principles — чёткие правила вида «делать/не делать» (по сегменту, формату, цене, каналам, роли основателя, темпу масштабирования).
• 5–7 красных флажков, которые будут сигнализировать о повторении паттернов провальных кейсов.

5. СТРАТЕГИЯ ВХОДА И ПЛАН ТЕСТОВ (discovery driven)
На основе анализа аналогов и антилогов:
• Предложи 2–3 режима входа в выбранную модель с перечислением плюсов и минусов каждого варианта.
• Для каждого режима опиши 2–3 малых эксперимента:
  - что именно тестируем;
  - какие метрики считаем показателями успеха;
  - какие пороговые значения означают «продолжать», «остановить» или «переформатировать».

В финале дай сжатую выжимку: опирайся на такие-то паттерны аналогов, избегай таких-то паттернов антилогов, и начинай с таких-то экспериментов — максимально конкретно, без общих слов.

Формат ответа: структурированный текст с bullets, таблицами, разделами. Пиши на русском языке.""",

    "track3_risks_analysis": """Твоя роль — эксперт по анализу клиентских болей и Jobs-to-be-Done.

КОНТЕКСТ БИЗНЕСА:
Отрасль и продукты: {industry_products}
Клиенты: {customers}
Бизнес-модель: {business_model}
География: {geography}
Ограничения: {constraints}

Проанализируй целевую аудиторию и её ключевые боли в контексте решения конкретной задачи или достижения результата. Сфокусируйся на job-to-be-done и desired outcomes клиентов. Используй логику Outcome-Driven Innovation (ODI): для каждого outcome оцени важность и степень удовлетворённости, чтобы выявить недообслуженные зоны.

1. КОНТЕКСТ И СЕГМЕНТ КЛИЕНТА
• Опиши, кто именно является целевым клиентом: роль, уровень ответственности, тип компании/сферы, ключевые KPI.
• В каких типичных ситуациях и условиях этот клиент сталкивается с задачей (job-to-be-done), которую потенциально можно улучшить.
• Какие внешние факторы (рынок, регуляция, технологии, внутренняя политика, культура) усиливают напряжение для этого клиента.

2. JOBS-TO-BE-DONE (JTBD)
• Сформулируй 3–5 ключевых jobs-to-be-done: что клиент пытается сделать/изменить/избежать, если полностью забыть про конкретный продукт и смотреть только на его задачи.
• Для каждого job опиши контекст: когда это происходит, что его запускает, каковы последствия успеха и неуспеха.

3. DESIRED OUTCOMES (по ODI)
Для каждого ключевого job:
• Сформулируй 8–15 desired outcome statements в стиле Strategyn:
  - формулировка должна описывать метрику успеха (скорость, предсказуемость, точность, стабильность, усилия, риски и т.п.),
  - быть независимой от решений («что улучшить» вместо «как»),
  - быть измеримой и контролируемой.

Примеры формата:
• «Сократить время, необходимое, чтобы …»
• «Уменьшить вероятность того, что …»
• «Повысить предсказуемость того, что …»
• «Снизить усилия, требуемые для …»

4. ФУНКЦИОНАЛЬНЫЕ И ЭМОЦИОНАЛЬНЫЕ БОЛИ
• Опиши, какие функциональные проблемы и препятствия возникают при попытке достичь перечисленных desired outcomes (время, ошибки, сложность, зависимости, недоступная информация и т.п.).
• Опиши эмоциональные и социальные боли: страх, тревога, ощущение потери контроля, репутационные риски, конфликты.
• Укажи, какие из болей связаны с недостижением конкретных desired outcomes.

5. ТЕКУЩИЕ РЕШЕНИЯ И РАЗРЫВ ОЖИДАНИЙ
• Как клиенты решают эти jobs сейчас: какие процессы, сервисы, инструменты, «костыли» используют.
• В чём состоят ключевые разрывы между текущим опытом и желаемыми outcomes (по 3–7 разрывов на job).
• Какие компромиссы клиенты вынуждены делать (скорость vs качество, цена vs удобство, контроль vs делегирование).

6. КВАНТИФИКАЦИЯ ПО ODI: importance / satisfaction / opportunity
Для каждого desired outcome:
• Оцени по шкале 1–10:
  - Importance — насколько важно для клиента улучшение этого outcome (1 — неважно, 10 — критично).
  - Satisfaction — насколько хорошо, по мнению клиента, он сейчас достигает этого outcome с существующими решениями (1 — совсем плохо, 10 — полностью доволен).
• Рассчитай opportunity score по формуле ODI (Strategyn):
  Opportunity = Importance + max(0, Importance - Satisfaction)
• Сформируй ранжированный список desired outcomes по убыванию opportunity score, помечая:
  - underserved (высокая важность, низкая удовлетворённость, высокий opportunity score);
  - adequately served;
  - overserved (высокая удовлетворённость при невысокой важности).

7. ПРИОРИТИЗАЦИЯ БОЛЕЙ И ГОТОВНОСТЬ ПЛАТИТЬ
• На основе opportunity score выдели 5–10 наиболее перспективных outcomes (underserved), которые:
  - критичны для бизнеса/карьеры клиента;
  - плохо закрыты текущими решениями;
  - реально могут быть улучшены через новый продукт/сервис.
• Опиши, какие из этих outcomes клиенты готовы решать в ближайшие 3–12 месяцев и почему.
• Как клиенты сами формулируют «идеальный результат» по top outcomes и за что, по их словам, готовы платить премиально.

8. УСЛОВИЯ УСПЕХА РЕШЕНИЯ И БАРЬЕРЫ
• Какие требования клиенты предъявляют к решению, способному улучшить top outcomes (формат, скорость внедрения, уровень риска, прозрачность, обратимость решений).
• Какие барьеры могут помешать даже при наличии сильного решения (регуляция, IT ограничения, культура, политика, бюджет, инерция).
• В каких сценариях клиент скажет: «Это именно то, что решает мои ключевые задачи» — опиши 3–5 сценариев, привязанных к конкретным high opportunity outcomes.

9. ВЫВОДЫ: ЧТО ИЗ ЭТОГО СЛЕДУЕТ ДЛЯ ДИЗАЙНА ПРОДУКТА/МОДЕЛИ
Сформулируй 7–10 ключевых выводов:
• какие outcomes нужно сделать ядром value proposition;
• какие сегменты (по набору desired outcomes) стоит обслуживать в первую очередь;
• какие требования к формату/каналам/цене следуют из структуры болей и opportunity scores;
• каких решений, наоборот, стоит избегать, потому что они закрывают overserved outcomes или создают малоценные улучшения.

Формат ответа: структурированный текст с bullets, таблицами, разделами. Пиши на русском языке."""
}

def load_prompts():
    db = SessionLocal()
    
    for track_name, prompt_text in PROMPTS.items():
        # Проверяем существует ли уже активный промпт
        existing = db.query(Prompt).filter(
            Prompt.track_name == track_name,
            Prompt.is_active == True
        ).first()
        
        if existing:
            print(f"⚠️  Промпт {track_name} уже существует (версия {existing.version})")
            continue
        
        # Создаем новый промпт
        new_prompt = Prompt(
            track_name=track_name,
            prompt_template=prompt_text,
            params={"temperature": 0.7, "max_tokens": 8000},
            version=1,
            updated_by="system",
            is_active=True
        )
        
        db.add(new_prompt)
        print(f"✅ Создан промпт: {track_name} (версия 1)")
    
    db.commit()
    print(f"\n✅ Промпты загружены в БД!")
    db.close()

if __name__ == "__main__":
    load_prompts()